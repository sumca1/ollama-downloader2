name: Download Large Models (with Split)

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Large model to download (will be split)'
        required: true
        default: 'llama3.1-70b'
        type: choice
        options:
          - llama3.1-70b
          - qwen2.5-72b
          - mixtral-8x7b

jobs:
  download-and-split:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v3
      
      - name: ğŸ” Set model details
        id: model_info
        run: |
          case "${{ github.event.inputs.model_name }}" in
            llama3.1-70b)
              echo "url=https://huggingface.co/bartowski/Meta-Llama-3.1-70B-Instruct-GGUF/resolve/main/Meta-Llama-3.1-70B-Instruct-Q4_K_M.gguf" >> $GITHUB_OUTPUT
              echo "filename=llama3.1-70b-q4.gguf" >> $GITHUB_OUTPUT
              echo "size=40GB" >> $GITHUB_OUTPUT
              ;;
            qwen2.5-72b)
              echo "url=https://huggingface.co/bartowski/Qwen2.5-72B-Instruct-GGUF/resolve/main/Qwen2.5-72B-Instruct-Q4_K_M.gguf" >> $GITHUB_OUTPUT
              echo "filename=qwen2.5-72b-q4.gguf" >> $GITHUB_OUTPUT
              echo "size=42GB" >> $GITHUB_OUTPUT
              ;;
            mixtral-8x7b)
              echo "url=https://huggingface.co/TheBloke/Mixtral-8x7B-Instruct-v0.1-GGUF/resolve/main/mixtral-8x7b-instruct-v0.1.Q4_K_M.gguf" >> $GITHUB_OUTPUT
              echo "filename=mixtral-8x7b-q4.gguf" >> $GITHUB_OUTPUT
              echo "size=26GB" >> $GITHUB_OUTPUT
              ;;
          esac
      
      - name: ğŸ“¥ Download large model
        run: |
          wget -q --show-progress -O "${{ steps.model_info.outputs.filename }}" "${{ steps.model_info.outputs.url }}" || \
          curl -sL --progress-bar -o "${{ steps.model_info.outputs.filename }}" "${{ steps.model_info.outputs.url }}"
          ls -lh "${{ steps.model_info.outputs.filename }}"
      
      - name: âœ‚ï¸ Split large file into 1.9GB chunks
        run: |
          split -b 1900M "${{ steps.model_info.outputs.filename }}" "${{ steps.model_info.outputs.filename }}.part"
          num_parts=$(ls -1 *.part* | wc -l)
          echo "num_parts=$num_parts" >> $GITHUB_ENV
      
      - name: ğŸ“Š Generate checksums for each part
        run: |
          for part in *.part*; do
            sha256sum "$part" > "$part.sha256"
          done
          sha256sum "${{ steps.model_info.outputs.filename }}" > "${{ steps.model_info.outputs.filename }}.sha256.full"
      
      - name: ğŸ“ Create merge script for Windows
        run: |
          cat > merge_parts.ps1 << 'EOF'
          #!/usr/bin/env pwsh
          <#
          .SYNOPSIS
              ××™×–×•×’ ×—×œ×§×™ ×”×§×•×‘×¥ ×—×–×¨×” ×œ××•×“×œ ×©×œ×
          
          .DESCRIPTION
              ×¡×§×¨×™×¤×˜ ×œ××™×–×•×’ ×›×œ ×”×—×œ×§×™× ×©×”×•×¨×“×ª ×-GitHub Releases
          
          .EXAMPLE
              .\merge_parts.ps1 -ModelName "llama3.1-70b-q4.gguf"
          #>
          
          param(
              [Parameter(Mandatory=$true)]
              [string]$ModelName
          )
          
          Write-Host "ğŸ”— ××™×–×•×’ ×—×œ×§×™ $ModelName..." -ForegroundColor Cyan
          
          # ××¦× ××ª ×›×œ ×”×—×œ×§×™×
          $parts = Get-ChildItem -Filter "${ModelName}.part*" | 
                   Where-Object { $_.Name -notmatch '\.sha256$' } | 
                   Sort-Object Name
          
          if ($parts.Count -eq 0) {
              Write-Host "âŒ ×œ× × ××¦××• ×—×œ×§×™×!" -ForegroundColor Red
              Write-Host "×•×“× ×©×”×•×¨×“×ª ××ª ×›×œ ×”×§×‘×¦×™×: ${ModelName}.part*" -ForegroundColor Yellow
              exit 1
          }
          
          Write-Host "× ××¦××• $($parts.Count) ×—×œ×§×™×" -ForegroundColor Green
          
          # ××™×–×•×’
          $output = New-Object System.IO.FileStream($ModelName, [System.IO.FileMode]::Create)
          
          foreach ($part in $parts) {
              Write-Host "××™×–×•×’: $($part.Name)..." -ForegroundColor Gray
              $input = [System.IO.File]::ReadAllBytes($part.FullName)
              $output.Write($input, 0, $input.Length)
          }
          
          $output.Close()
          
          Write-Host "âœ… ××™×–×•×’ ×”×•×©×œ×!" -ForegroundColor Green
          Write-Host "×§×•×‘×¥ ×¡×•×¤×™: $ModelName" -ForegroundColor Cyan
          
          # ×‘×“×™×§×ª ×’×•×“×œ
          $size = (Get-Item $ModelName).Length / 1GB
          Write-Host "×’×•×“×œ: $([math]::Round($size, 2)) GB" -ForegroundColor White
          
          # ××™××•×ª checksum (×× ×§×™×™×)
          $checksumFile = "${ModelName}.sha256.full"
          if (Test-Path $checksumFile) {
              Write-Host "`n××××ª checksum..." -ForegroundColor Yellow
              $expectedHash = (Get-Content $checksumFile).Split()[0]
              $actualHash = (Get-FileHash $ModelName -Algorithm SHA256).Hash.ToLower()
              
              if ($expectedHash -eq $actualHash) {
                  Write-Host "âœ… Checksum ×ª×§×™×Ÿ!" -ForegroundColor Green
              } else {
                  Write-Host "âŒ Checksum ×œ× ×ª×•××!" -ForegroundColor Red
                  Write-Host "Expected: $expectedHash" -ForegroundColor Gray
                  Write-Host "Actual: $actualHash" -ForegroundColor Gray
              }
          }
          
          Write-Host "`nğŸ‰ ×¡×™×™×× ×•! ×”××•×“×œ ××•×›×Ÿ ×œ×©×™××•×©" -ForegroundColor Cyan
          EOF
          
          # ×’× ×¡×§×¨×™×¤×˜ ×œ×™× ×•×§×¡/××§
          cat > merge_parts.sh << 'EOF'
          #!/bin/bash
          
          MODEL_NAME="$1"
          
          if [ -z "$MODEL_NAME" ]; then
              echo "Usage: ./merge_parts.sh <model-name>"
              echo "Example: ./merge_parts.sh llama3.1-70b-q4.gguf"
              exit 1
          fi
          
          echo "ğŸ”— Merging parts of $MODEL_NAME..."
          
          # ××™×–×•×’ ×›×œ ×”×—×œ×§×™×
          cat ${MODEL_NAME}.part* > $MODEL_NAME
          
          echo "âœ… Merge completed!"
          ls -lh $MODEL_NAME
          
          # ××™××•×ª
          if [ -f "${MODEL_NAME}.sha256.full" ]; then
              echo "Verifying checksum..."
              sha256sum -c "${MODEL_NAME}.sha256.full"
          fi
          
          echo "ğŸ‰ Done! Model ready to use"
          EOF
          
          chmod +x merge_parts.sh
          
          echo "âœ… Merge scripts created!"
      
      - name: ğŸ“¦ Download Ollama
        run: |
          wget -q -O ollama-windows.exe https://github.com/ollama/ollama/releases/latest/download/ollama-windows-amd64.exe || \
          curl -sL -o ollama-windows.exe https://github.com/ollama/ollama/releases/latest/download/ollama-windows-amd64.exe
      
      - name: ğŸ“ Create detailed README
        run: |
          cat > DOWNLOAD_INSTRUCTIONS.md << EOF
          # ğŸ“¥ ×”×•×¨××•×ª ×”×•×¨×“×” ×•××™×–×•×’ - ${{ github.event.inputs.model_name }}
          
          ## ğŸ“¦ ××” ×”×•×¨×“×ª?
          
          ×”××•×“×œ **${{ github.event.inputs.model_name }}** (${{ steps.model_info.outputs.size }}) ×¤×•×¦×œ ×œ-**${num_parts} ×—×œ×§×™×**.
          
          ## ğŸ”½ ×©×œ×‘ 1: ×”×•×¨×“×ª ×›×œ ×”×§×‘×¦×™×
          
          ×”×•×¨×“ ××ª **×›×œ ×”×§×‘×¦×™×** ×-Assets ×œ××˜×”:
          
          ### ×§×‘×¦×™ ×”××•×“×œ:
          - \`${{ steps.model_info.outputs.filename }}.partaa\`
          - \`${{ steps.model_info.outputs.filename }}.partab\`
          - \`${{ steps.model_info.outputs.filename }}.partac\`
          - ... (×›×œ ×”-part ×§×‘×¦×™×)
          
          ### ×§×‘×¦×™ ×¢×–×¨:
          - \`merge_parts.ps1\` - ×¡×§×¨×™×¤×˜ ××™×–×•×’ ×œWindows
          - \`merge_parts.sh\` - ×¡×§×¨×™×¤×˜ ××™×–×•×’ ×œLinux/Mac
          - \`${{ steps.model_info.outputs.filename }}.sha256.full\` - Checksum ×œ××™××•×ª
          - \`ollama-windows.exe\` - Ollama
          
          ---
          
          ## ğŸ”— ×©×œ×‘ 2: ××™×–×•×’ ×”×—×œ×§×™×
          
          ### ×‘-Windows (PowerShell):
          
          \`\`\`powershell
          # 1. ×©×™× ××ª ×›×œ ×”×§×‘×¦×™× ×‘××•×ª×” ×ª×™×§×™×™×”
          cd C:\Users\YOUR_NAME\Downloads
          
          # 2. ×”×¨×¥ ××ª ×¡×§×¨×™×¤×˜ ×”××™×–×•×’
          .\merge_parts.ps1 -ModelName "${{ steps.model_info.outputs.filename }}"
          
          # 3. ×”××ª×Ÿ... (×œ×•×§×— ×›-5 ×“×§×•×ª)
          
          # 4. ×”××•×“×œ ××•×›×Ÿ! ×™×”×™×” ×œ×š:
          #    ${{ steps.model_info.outputs.filename }} (×§×•×‘×¥ ××œ×)
          \`\`\`
          
          ### ×‘-Linux/Mac:
          
          \`\`\`bash
          # 1. ×©×™× ××ª ×›×œ ×”×§×‘×¦×™× ×‘××•×ª×” ×ª×™×§×™×™×”
          cd ~/Downloads
          
          # 2. ×”×¨×¥ ××™×–×•×’
          chmod +x merge_parts.sh
          ./merge_parts.sh "${{ steps.model_info.outputs.filename }}"
          
          # 3. ×”××•×“×œ ××•×›×Ÿ!
          \`\`\`
          
          ### ××•×¤×¦×™×” ×™×“× ×™×ª (×œ×œ× ×¡×§×¨×™×¤×˜):
          
          **Windows (CMD):**
          \`\`\`cmd
          copy /b ${{ steps.model_info.outputs.filename }}.part* ${{ steps.model_info.outputs.filename }}
          \`\`\`
          
          **Linux/Mac:**
          \`\`\`bash
          cat ${{ steps.model_info.outputs.filename }}.part* > ${{ steps.model_info.outputs.filename }}
          \`\`\`
          
          ---
          
          ## âœ… ×©×œ×‘ 3: ××™××•×ª (××•×¤×¦×™×•× ×œ×™)
          
          \`\`\`powershell
          # Windows
          Get-FileHash "${{ steps.model_info.outputs.filename }}" -Algorithm SHA256
          Get-Content "${{ steps.model_info.outputs.filename }}.sha256.full"
          # ×”×©×•×•×” ××ª ×©× ×™ ×”-hash
          \`\`\`
          
          \`\`\`bash
          # Linux/Mac
          sha256sum -c "${{ steps.model_info.outputs.filename }}.sha256.full"
          \`\`\`
          
          ---
          
          ## ğŸš€ ×©×œ×‘ 4: ×”×¤×¢×œ×”
          
          \`\`\`powershell
          # ×”×¢×‘×¨ ××ª ×”××•×“×œ ×œ×ª×™×§×™×™×ª Ollama
          New-Item -ItemType Directory -Path "\$HOME\.ollama\models" -Force
          Move-Item "${{ steps.model_info.outputs.filename }}" "\$HOME\.ollama\models\"
          
          # ×”×¤×¢×œ Ollama
          .\ollama-windows.exe serve
          
          # ×‘×—×œ×•×Ÿ × ×¤×¨×“:
          .\ollama-windows.exe run ${{ github.event.inputs.model_name }}
          \`\`\`
          
          ---
          
          ## ğŸ“Š ××™×“×¢ ×˜×›× ×™
          
          - **×’×•×“×œ ××§×•×¨×™:** ${{ steps.model_info.outputs.size }}
          - **××¡×¤×¨ ×—×œ×§×™×:** ${num_parts}
          - **×’×•×“×œ ×›×œ ×—×œ×§:** ~1.9GB
          - **×–××Ÿ ××™×–×•×’ ××©×•×¢×¨:** 3-10 ×“×§×•×ª
          - **××§×•× ×¤× ×•×™ × ×“×¨×©:** ${{ steps.model_info.outputs.size }} Ã— 2 (×§×‘×¦×™× + ××•×“×œ ×××•×—×“)
          
          ---
          
          ## â“ ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª
          
          ### "×—×¡×¨ ×§×•×‘×¥ partXX"
          - ×•×“× ×©×”×•×¨×“×ª **××ª ×›×œ** ×”×§×‘×¦×™× ×-Assets
          - ×‘×“×•×§ ×©××™×Ÿ ×©×’×™××•×ª ×”×•×¨×“×”
          
          ### "Checksum ×œ× ×ª×•××"
          - ×”×•×¨×“ ××—×“×© ××ª ×”×—×œ×§ ×”×¤×’×•×
          - ×‘×“×•×§ ×©×œ× ×©×™× ×™×ª ×©××•×ª ×§×‘×¦×™×
          
          ### "××™×Ÿ ××¡×¤×™×§ ××§×•×"
          - ×¦×¨×™×š ×¤×™ 2 ××”×’×•×“×œ (×§×‘×¦×™× + ××•×“×œ)
          - ××—×§ ×§×‘×¦×™ .part ××—×¨×™ ×”××™×–×•×’
          
          ---
          
          **×‘×”×¦×œ×—×”! ğŸ‰**
          EOF
      
      - name: ğŸ‰ Create GitHub Release with all parts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.model_name }}-split-${{ github.run_number }}
          name: ğŸ“¦ ${{ github.event.inputs.model_name }} (Split Parts)
          body_path: DOWNLOAD_INSTRUCTIONS.md
          files: |
            ${{ steps.model_info.outputs.filename }}.part*
            *.sha256
            merge_parts.ps1
            merge_parts.sh
            ollama-windows.exe
            DOWNLOAD_INSTRUCTIONS.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ§¹ Cleanup (remove original large file)
        run: |
          rm -f "${{ steps.model_info.outputs.filename }}"
      
      - name: âœ… Success Summary
        run: |
          echo "Done: ${{ github.event.inputs.model_name }} - ${num_parts} parts"
